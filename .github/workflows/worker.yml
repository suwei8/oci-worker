name: OCI Worker (Public)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *' # Run every 6 hours (matches max runtime)



jobs:
  worker:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Download Worker
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          echo "Downloading worker binary from private repo..."
          gh release download worker-build -R suwei8/OCI-Manager-Go -p "oci-manager-worker-linux-amd64" --clobber
          mv oci-manager-worker-linux-amd64 oci-manager
          chmod +x oci-manager

      - name: Check Connectivity
        env:
          OCI_SERVER_URL: ${{ secrets.OCI_SERVER_URL }}
        run: |
          echo "Checking connectivity to $OCI_SERVER_URL..."
          curl -v "$OCI_SERVER_URL/health" || echo "Warning: Connectivity check failed"
          curl -v "$OCI_SERVER_URL/" || echo "Warning: Root check failed"

      - name: Run Worker
        env:
          OCI_SERVER_URL: ${{ secrets.OCI_SERVER_URL }}
          OCI_WORKER_TOKEN: ${{ secrets.OCI_WORKER_TOKEN }}
        run: |
          # Run for up to 350 minutes (approx 6h limit)
          timeout 350m ./oci-manager worker --server-url "$OCI_SERVER_URL" --token "$OCI_WORKER_TOKEN" || true
